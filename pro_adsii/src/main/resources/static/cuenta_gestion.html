<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Cuentas Corrientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
        }

        th,
        td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.85em; 
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3" id="navUsuario">Usuario: Cargando...</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4 text-center">üíº Gesti√≥n de Cuentas Corrientes</h2>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white" id="form-title">‚ûï Crear Nueva Cuenta</div>
            <div class="card-body">
                <form id="cuenta-form">
                    <input type="hidden" id="idCuentaCorriente">
                    <input type="hidden" id="usuario" value="usuario_logeado_ejemplo"> 

                    <div class="row g-3">
                        
                        <div class="col-md-4">
                            <label for="idPersona" class="form-label">Cliente:</label>
                            <select id="idPersona" class="form-select" required>
                                <option value="">-- Seleccione Cliente --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="idTipoSaldoCuenta" class="form-label">Tipo de Saldo:</label>
                            <select id="idTipoSaldoCuenta" class="form-select" required>
                                <option value="">-- Seleccione Tipo --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="idStatusCuenta" class="form-label">Estado de Cuenta:</label>
                            <select id="idStatusCuenta" class="form-select" required>
                                <option value="">-- Seleccione Estado --</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="fechaApertura" class="form-label">Fecha de Apertura (Opcional):</label>
                            <input type="datetime-local" id="fechaApertura" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label for="saldoAnterior" class="form-label">Saldo Anterior:</label>
                            <input type="number" step="0.01" id="saldoAnterior" class="form-control" value="0.00" required>
                        </div>
                        <div class="col-md-4">
                            <label for="debitos" class="form-label">D√©bitos:</label>
                            <input type="number" step="0.01" id="debitos" class="form-control" value="0.00" required>
                        </div>
                        <div class="col-md-4">
                            <label for="creditos" class="form-label">Cr√©ditos:</label>
                            <input type="number" step="0.01" id="creditos" class="form-control" value="0.00" required>
                        </div>
                        <div class="col-12 mt-4 d-flex gap-2 justify-content-end">
                            <button type="submit" class="btn btn-success" id="btnGuardar">üíæ Guardar Cuenta</button>
                            <button type="button" id="btnCancelar" class="btn btn-secondary">‚ùå Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">üìã Listado de Cuentas Corrientes</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Saldo</th>
                                <th>N¬∞ Cuenta</th>
                                <th>Cliente</th>
                                <th>Tipo Saldo</th>
                                <th>Estado</th>
                                <th>Fec. Apertura</th>
                                <th>Saldo Ant.</th>
                                <th>D√©bitos</th>
                                <th>Cr√©ditos</th>
                                <th>Fec. Creaci√≥n</th>
                                <th>Usuario Creaci√≥n</th>
                                <th>Fec. Modificaci√≥n</th>
                                <th>Usuario Modificaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuentas-table">
                            <tr>
                                <td colspan="14" class="text-center">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = '/cuentas';
        const API_PERSONA = '/persona'; 
        const API_TIPO_SALDO = '/tipo-saldo/listar';
        const API_STATUS_CUENTA = '/statuscuenta';

        const usuario = document.getElementById('usuario').value;
        document.getElementById('navUsuario').textContent = 'Usuario: ' + usuario;

        const formatDateTime = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('es-ES');
        };

        async function cargarDropdown(url, selectId, idField, nameField, customTextFunc) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="">-- Seleccione ${selectId.replace('id', '')} --</option>`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                data.forEach(item => {
                    const text = customTextFunc ? customTextFunc(item) : item[nameField];
                    select.innerHTML += `<option value="${item[idField]}">${text}</option>`;
                });
            } catch (error) {
                console.error(`Error al cargar ${selectId} desde ${url}:`, error);
                select.innerHTML += `<option value="" disabled>Error al cargar datos</option>`;
            }
        }

        async function inicializarDropdowns() {
            await cargarDropdown(API_PERSONA, 'idPersona', 'idPersona', 'nombre', (item) => `${item.nombre} ${item.apellido || ''}`);
            await cargarDropdown(API_TIPO_SALDO, 'idTipoSaldoCuenta', 'idTipoSaldoCuenta', 'nombre');
            await cargarDropdown(API_STATUS_CUENTA, 'idStatusCuenta', 'idStatusCuenta', 'nombre');
        }

        async function listarCuentas() {
            const tbody = document.getElementById('cuentas-table');
            tbody.innerHTML = `<tr><td colspan="14" class="text-center">Cargando...</td></tr>`;
            try {
                const res = await fetch(API_BASE);
                const cuentas = await res.json();

                if (cuentas.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="14" class="text-center">No hay cuentas registradas.</td></tr>`;
                    return;
                }

                tbody.innerHTML = '';
                cuentas.forEach(c => {
                    const cliente = c.persona ? `${c.persona.nombre} ${c.persona.apellido}` : 'N/A';
                    const tipo = c.tipoSaldoCuenta ? c.tipoSaldoCuenta.nombre : 'N/A';
                    const estado = c.statusCuenta ? c.statusCuenta.nombre : 'N/A';

                    tbody.innerHTML += `
                        <tr>
                            <td>${c.idSaldoCuenta}</td>
                            <td>${c.numeroCuenta || c.idSaldoCuenta || 'N/A'}</td>
                            <td>${cliente}</td>
                            <td>${tipo}</td>
                            <td>${estado}</td>
                            <td>${formatDateTime(c.fechaApertura)}</td>
                            <td class="text-end">${c.saldoAnterior ? c.saldoAnterior.toFixed(2) : '0.00'}</td>
                            <td class="text-end">${c.debitos ? c.debitos.toFixed(2) : '0.00'}</td>
                            <td class="text-end">${c.creditos ? c.creditos.toFixed(2) : '0.00'}</td>
                            <td>${formatDateTime(c.fechaCreacion)}</td>
                            <td>${c.usuarioCreacion || 'N/A'}</td>
                            <td>${c.fechaModificacion ? formatDateTime(c.fechaModificacion) : 'N/A'}</td>
                            <td>${c.usuarioModificacion || 'N/A'}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editarCuenta(${c.idSaldoCuenta})">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarCuenta(${c.idSaldoCuenta})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="14" class="text-center">Error al cargar las cuentas.</td></tr>`;
            }
        }

        document.getElementById('cuenta-form').addEventListener('submit', async e => {
            e.preventDefault();

            const id = document.getElementById('idCuentaCorriente').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/${id}` : API_BASE;
            const isUpdate = !!id;

            let cuentaPayload = {};
            const getDecimalValue = (id) => parseFloat(document.getElementById(id).value) || 0;

            if (isUpdate) {
                // PAYLOAD de actualizaci√≥n
                cuentaPayload = {
                    saldoAnterior: getDecimalValue('saldoAnterior'),
                    debitos: getDecimalValue('debitos'),
                    creditos: getDecimalValue('creditos'),
                    tipoSaldoCuenta: { idTipoSaldoCuenta: parseInt(document.getElementById('idTipoSaldoCuenta').value) },
                    statusCuenta: { idStatusCuenta: parseInt(document.getElementById('idStatusCuenta').value) },
                    usuarioModificacion: usuario 
                };
            } else {
                // Aseguramos que fechaApertura tenga un valor para evitar el error "not-null"
                let fechaAperturaValue = document.getElementById('fechaApertura').value;
                if (!fechaAperturaValue) {
                    fechaAperturaValue = new Date().toISOString().slice(0, 16); 
                }

                // PAYLOAD de creaci√≥n
                cuentaPayload = {
                    fechaApertura: fechaAperturaValue, 
                    persona: { idPersona: parseInt(document.getElementById('idPersona').value) },
                    tipoSaldoCuenta: { idTipoSaldoCuenta: parseInt(document.getElementById('idTipoSaldoCuenta').value) },
                    statusCuenta: { idStatusCuenta: parseInt(document.getElementById('idStatusCuenta').value) },
                    saldoAnterior: getDecimalValue('saldoAnterior'),
                    debitos: getDecimalValue('debitos'),
                    creditos: getDecimalValue('creditos'),
                    usuarioCreacion: usuario,
                    // No enviamos numeroCuenta, se genera en el backend con el ID.
                    numeroCuenta: "0" // Valor temporal para evitar errores de deserializaci√≥n si la BD lo pide NOT NULL
                };
            }

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cuentaPayload)
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert(`Error al guardar: ${text}`);
                    return;
                }

                cancelarEdicion();
                listarCuentas();
            } catch (err) {
                console.error(err);
                alert("Error al guardar la cuenta.");
            }
        });

        async function editarCuenta(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}`);
                const c = await res.json();

                document.getElementById('idCuentaCorriente').value = c.idSaldoCuenta;
                
                document.getElementById('saldoAnterior').value = c.saldoAnterior || '0.00';
                document.getElementById('debitos').value = c.debitos || '0.00';
                document.getElementById('creditos').value = c.creditos || '0.00';
                
                document.getElementById('idPersona').disabled = true;
                document.getElementById('fechaApertura').disabled = true; 

                document.getElementById('idPersona').value = c.persona.idPersona;
                document.getElementById('idTipoSaldoCuenta').value = c.tipoSaldoCuenta.idTipoSaldoCuenta;
                document.getElementById('idStatusCuenta').value = c.statusCuenta.idStatusCuenta;

                if (c.fechaApertura) {
                    const date = new Date(c.fechaApertura);
                    const localDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                    document.getElementById('fechaApertura').value = localDateTime;
                } else {
                    document.getElementById('fechaApertura').value = '';
                }

                document.getElementById('form-title').textContent = `‚úçÔ∏è Editar Cuenta (ID: ${c.idSaldoCuenta} / N¬∞ Cuenta: ${c.numeroCuenta || c.idSaldoCuenta})`;
                document.getElementById('btnGuardar').textContent = "Actualizar";
            } catch (err) {
                alert("Error al editar cuenta: " + err.message);
            }
        }

        async function eliminarCuenta(id) {
            if (!confirm('¬øEliminar esta cuenta?')) return;
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const text = await res.text();
                    alert(`Error al eliminar: ${text}`);
                }
                listarCuentas();
            } catch (err) {
                console.error(err);
                alert("Error al eliminar cuenta.");
            }
        }

        function cancelarEdicion() {
            document.getElementById('cuenta-form').reset();
            document.getElementById('idCuentaCorriente').value = '';
            
            document.getElementById('saldoAnterior').value = '0.00';
            document.getElementById('debitos').value = '0.00';
            document.getElementById('creditos').value = '0.00';

            document.getElementById('idPersona').disabled = false;
            document.getElementById('fechaApertura').disabled = false;

            document.getElementById('form-title').textContent = "‚ûï Crear Nueva Cuenta";
            document.getElementById('btnGuardar').textContent = "üíæ Guardar Cuenta";
        }

        document.getElementById('btnCancelar').addEventListener('click', cancelarEdicion);

        inicializarDropdowns();
        listarCuentas();
    </script>
</body>

</html>