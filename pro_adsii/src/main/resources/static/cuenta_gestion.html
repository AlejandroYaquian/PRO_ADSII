<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Cuentas Corrientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3" id="navUsuario">Usuario: Cargando...</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="container py-5">
            <h2 class="mb-4 text-center">Gesti√≥n de Cuentas Corrientes</h2>

            <div class="card mb-4">
                <div class="card-header" id="form-title">‚ûï Crear Nueva Cuenta</div>
                <div class="card-body">
                    <form id="cuenta-form">
                        <input type="hidden" id="idCuentaCorriente">
                        <input type="hidden" id="usuario" value="admin_web_user"> 

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="numeroCuenta" class="form-label">N√∫mero de Cuenta:</label>
                                <input type="text" id="numeroCuenta" class="form-control" placeholder="N√∫mero de Cuenta" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="idPersona" class="form-label">Cliente:</label>
                                <select id="idPersona" class="form-select" required>
                                    <option value="">-- Seleccione Cliente --</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="idTipoSaldoCuenta" class="form-label">Tipo de Saldo:</label>
                                <select id="idTipoSaldoCuenta" class="form-select" required>
                                    <option value="">-- Seleccione Tipo --</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="idStatusCuenta" class="form-label">Estado de Cuenta:</label>
                                <select id="idStatusCuenta" class="form-select" required>
                                    <option value="">-- Seleccione Estado --</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="fechaApertura" class="form-label">Fecha de Apertura:</label>
                                <input type="datetime-local" id="fechaApertura" class="form-control" />
                            </div>
                            
                            <div class="col-12 mt-4 d-flex gap-2 justify-content-end">
                                <button type="submit" class="btn btn-primary" id="btnGuardar">üíæ Guardar Cuenta</button>
                                <button type="button" id="btnCancelar" class="btn btn-secondary">‚ùå Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üìã Listado de Cuentas Corrientes</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>N¬∞ Cuenta</th>
                                    <th>Cliente</th>
                                    <th>Tipo Saldo</th>
                                    <th>Estado</th>
                                    <th>Fecha Apertura</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuentas-table">
                                <tr>
                                    <td colspan="7" class="text-center">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ‚≠ê‚≠ê ENDPOINTS CORREGIDOS PARA COINCIDIR CON LOS CONTROLLERS EN JAVA ‚≠ê‚≠ê
        const API_BASE = '/cuentas'; 
        const API_PERSONA = '/persona'; 
        const API_TIPO_SALDO = '/tipo-saldo/listar'; 
        const API_STATUS_CUENTA = '/statuscuenta'; 
        
        const usuario = document.getElementById('usuario').value;
        document.getElementById('navUsuario').textContent = 'Usuario: ' + usuario;

        // Funci√≥n auxiliar para formatear la fecha
        const formatDateTime = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(',', '');
        };
        
        // Funci√≥n para cargar los dropdowns (selects)
        async function cargarDropdown(url, selectId, idField, nameField) {
            const select = document.getElementById(selectId);
            try {
                const res = await fetch(url);
                const data = await res.json();
                data.forEach(item => {
                    // Si tiene nombre y apellido (como Persona), √∫salos. De lo contrario, usa el campo de nombre simple.
                    const text = (item.nombre && item.apellido) ? `${item.nombre} ${item.apellido}` : item[nameField];
                    select.innerHTML += `<option value="${item[idField]}">${text}</option>`;
                });
            } catch (error) {
                console.error(`Error al cargar ${selectId} desde ${url}:`, error);
                select.innerHTML += `<option value="" disabled>Error al cargar datos</option>`;
            }
        }
        
        // Inicializar todos los dropdowns
        async function inicializarDropdowns() {
             await cargarDropdown(API_PERSONA, 'idPersona', 'idPersona', 'nombre'); 
             await cargarDropdown(API_TIPO_SALDO, 'idTipoSaldoCuenta', 'idTipoSaldoCuenta', 'nombre');
             await cargarDropdown(API_STATUS_CUENTA, 'idStatusCuenta', 'idStatusCuenta', 'nombre');
        }

        // Funci√≥n para listar las cuentas (CRUD - Read)
        async function listarCuentas() {
            const tbody = document.getElementById('cuentas-table');
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">Cargando...</td></tr>`;

            try {
                const res = await fetch(API_BASE);
                const cuentas = await res.json();

                tbody.innerHTML = '';
                if (cuentas.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center">No hay cuentas corrientes registradas.</td></tr>`;
                    return;
                }

                cuentas.forEach(c => {
                    // NOTA: Se asume que Persona y StatusCuenta tienen un campo 'nombre' para mostrar.
                    const clienteNombre = (c.persona && c.persona.nombre && c.persona.apellido) ? `${c.persona.nombre} ${c.persona.apellido}` : 'N/A';
                    const tipoSaldoNombre = (c.tipoSaldoCuenta && c.tipoSaldoCuenta.nombre) ? c.tipoSaldoCuenta.nombre : 'N/A';
                    const statusNombre = (c.statusCuenta && c.statusCuenta.nombre) ? c.statusCuenta.nombre : 'N/A';

                    const row = `
                        <tr>
                            <td>${c.idCuentaCorriente}</td>
                            <td>${c.numeroCuenta}</td>
                            <td>${clienteNombre}</td>
                            <td>${tipoSaldoNombre}</td>
                            <td>${statusNombre}</td>
                            <td>${formatDateTime(c.fechaApertura)}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editarCuenta(${c.idCuentaCorriente})">‚úçÔ∏è Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarCuenta(${c.idCuentaCorriente})">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error("Error al cargar cuentas:", error);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">Error al cargar los datos.</td></tr>`;
            }
        }

        // Manejador del Formulario (CRUD - Create/Update)
        document.getElementById('cuenta-form').addEventListener('submit', async e => {
            e.preventDefault();

            const id = document.getElementById('idCuentaCorriente').value;
            const isUpdate = !!id;
            const method = isUpdate ? 'PUT' : 'POST';
            const url = isUpdate ? `${API_BASE}/${id}` : API_BASE;
            
            // Recolecci√≥n de datos
            const cuenta = {
                idCuentaCorriente: isUpdate ? parseInt(id) : null,
                numeroCuenta: document.getElementById('numeroCuenta').value,
                fechaApertura: document.getElementById('fechaApertura').value,
                
                // Objetos anidados solo con el ID
                persona: { idPersona: parseInt(document.getElementById('idPersona').value) },
                tipoSaldoCuenta: { idTipoSaldoCuenta: parseInt(document.getElementById('idTipoSaldoCuenta').value) },
                statusCuenta: { idStatusCuenta: parseInt(document.getElementById('idStatusCuenta').value) }
            };

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'usuario': usuario // Pasamos el usuario en el header
                    },
                    body: JSON.stringify(cuenta)
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    
                    // ‚≠ê‚≠ê GESTI√ìN DE ERRORES DE VALIDACI√ìN (400 Bad Request) ‚≠ê‚≠ê
                    if (res.status === 400) {
                        alert(`¬°ERROR DE GESTI√ìN! ${errorText}`);
                    } else {
                        alert(`Error al guardar/actualizar la cuenta. Detalles: ${errorText}`);
                    }
                    // ‚≠ê‚≠ê FIN GESTI√ìN DE ERRORES ‚≠ê‚≠ê
                    
                    return;
                }

                cancelarEdicion();
                listarCuentas();
            } catch (error) {
                console.error("Error en la solicitud:", error);
                alert("Ocurri√≥ un error de conexi√≥n al intentar guardar la cuenta.");
            }
        });

        // Cargar datos para edici√≥n (CRUD - Read Single for Edit)
        async function editarCuenta(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}`);
                const c = await res.json();
                
                // Rellenar formulario
                document.getElementById('idCuentaCorriente').value = c.idCuentaCorriente;
                document.getElementById('numeroCuenta').value = c.numeroCuenta;
                
                // Rellenar selects con el ID de la entidad relacionada
                document.getElementById('idPersona').value = c.persona.idPersona;
                document.getElementById('idTipoSaldoCuenta').value = c.tipoSaldoCuenta.idTipoSaldoCuenta;
                document.getElementById('idStatusCuenta').value = c.statusCuenta.idStatusCuenta;
                
                // Rellenar Fecha de Apertura (formato YYYY-MM-DDTHH:mm)
                if (c.fechaApertura) {
                    const date = new Date(c.fechaApertura);
                    const formattedDate = date.toISOString().substring(0, 16);
                    document.getElementById('fechaApertura').value = formattedDate;
                } else {
                    document.getElementById('fechaApertura').value = '';
                }

                document.getElementById('form-title').innerText = '‚úçÔ∏è Editar Cuenta Corriente';
                document.getElementById('btnGuardar').innerText = 'Actualizar';
            } catch (error) {
                console.error("Error al obtener cuenta para edici√≥n:", error);
                alert("Error al cargar los datos de la cuenta para edici√≥n.");
            }
        }

        // Funci√≥n para eliminar (CRUD - Delete)
        async function eliminarCuenta(id) {
            if (confirm('¬øSeguro que deseas eliminar esta cuenta? Esta acci√≥n es irreversible.')) {
                try {
                    const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                    // NOTA: La validaci√≥n de estado para DELETE debe estar en el Service/Controller
                    if (!res.ok) {
                        const errorText = await res.text();
                        alert(`Error al eliminar la cuenta. Detalles: ${errorText}`);
                    }
                    listarCuentas();
                } catch (error) {
                    console.error("Error al eliminar:", error);
                    alert("Ocurri√≥ un error de conexi√≥n al intentar eliminar la cuenta.");
                }
            }
        }

        // Funci√≥n para limpiar y resetear el formulario
        function cancelarEdicion() {
            document.getElementById('cuenta-form').reset();
            document.getElementById('idCuentaCorriente').value = '';
            document.getElementById('form-title').innerText = '‚ûï Crear Nueva Cuenta';
            document.getElementById('btnGuardar').innerText = 'üíæ Guardar Cuenta';
        }

        document.getElementById('btnCancelar').addEventListener('click', cancelarEdicion);

        // Inicializaci√≥n: Cargar selects y tabla
        inicializarDropdowns();
        listarCuentas();
    </script>
</body>

</html>