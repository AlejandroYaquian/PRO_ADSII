<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>CRUD Documento Persona</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3 fw-semibold" id="navUsuario"></span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">Gestión de Documentos de Persona</h2>

        <div class="card mb-4">
            <div class="card-header">
                <h5 id="form-title">Nuevo Documento</h5>
            </div>
            <div class="card-body">
                <form id="documento-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Persona</label>
                            <select id="idPersona" class="form-control" required>
                                <option value="">-- Seleccionar Persona --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Tipo de Documento</label>
                            <select id="idTipoDocumento" class="form-control" required>
                                <option value="">-- Seleccionar Tipo --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>No Documento</label>
                            <input type="text" id="noDocumento" class="form-control" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" id="cancelar" class="btn btn-secondary">Cancelar</button>
                </form>
            </div>
        </div>

        <div class="mb-3">
            <label>Buscar por Persona:</label>
            <input type="text" id="buscarPersona" class="form-control" placeholder="Escribe nombre o apellido">
        </div>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Persona</th>
                    <th>Tipo Documento</th>
                    <th>No Documento</th>
                    <th>Fecha Creación</th>
                    <th>Usuario Creación</th>
                    <th>Fecha Modificación</th>
                    <th>Usuario Modificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="documentos-table"></tbody>
        </table>
    </div>

    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <script>
        const usuario = sessionStorage.getItem('usuarioActual') || 'system';
        const apiBase = '/documento';
        let documentos = [];

        if (!usuario) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('navUsuario').textContent = usuario;
        }

        function mostrarMensaje(mensaje, tipo = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        async function listarDocumentos() {
            const res = await fetch(apiBase);
            documentos = await res.json();
            mostrarDocumentos(documentos);
        }

        function mostrarDocumentos(docs) {
            const tbody = document.getElementById('documentos-table');
            tbody.innerHTML = '';
            docs.forEach(d => {
                tbody.innerHTML += `
                    <tr>
                        <td>${d.persona?.nombre ?? ''} ${d.persona?.apellido ?? ''}</td>
                        <td>${d.tipoDocumento?.nombre ?? ''}</td>
                        <td>${d.noDocumento}</td>
                        <td>${d.fechaCreacion ?? ''}</td>
                        <td>${d.usuarioCreacion ?? ''}</td>
                        <td>${d.fechaModificacion ?? ''}</td>
                        <td>${d.usuarioModificacion ?? ''}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editarDocumento(${d.id.idTipoDocumento}, ${d.id.idPersona})">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarDocumento(${d.id.idTipoDocumento}, ${d.id.idPersona})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
        }

        document.getElementById('buscarPersona').addEventListener('input', e => {
            const valor = e.target.value.toLowerCase();
            const filtrados = documentos.filter(d => {
                const nombreCompleto = `${d.persona?.nombre ?? ''} ${d.persona?.apellido ?? ''}`.toLowerCase();
                return nombreCompleto.includes(valor);
            });
            mostrarDocumentos(filtrados);
        });

        async function cargarPersonas() {
            const res = await fetch('/documento/listarPersonas');
            const personas = await res.json();
            const select = document.getElementById('idPersona');
            select.innerHTML = '<option value="">-- Seleccionar Persona --</option>';
            personas.forEach(p => {
                select.innerHTML += `<option value="${p.idPersona}">${p.nombre} ${p.apellido}</option>`;
            });
        }

        async function cargarTipoDocumento() {
            const res = await fetch('/documento/listarTipoDocumento');
            const tipos = await res.json();
            const select = document.getElementById('idTipoDocumento');
            select.innerHTML = '<option value="">-- Seleccionar Tipo --</option>';
            tipos.forEach(t => {
                select.innerHTML += `<option value="${t.idTipoDocumento}">${t.nombre}</option>`;
            });
        }

        document.getElementById('documento-form').addEventListener('submit', async e => {
            e.preventDefault();
            const doc = {
                id: {
                    idPersona: parseInt(document.getElementById('idPersona').value),
                    idTipoDocumento: parseInt(document.getElementById('idTipoDocumento').value)
                },
                noDocumento: document.getElementById('noDocumento').value
            };
            try {
                const res = await fetch(apiBase, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'usuario': usuario },
                    body: JSON.stringify(doc)
                });
                if (!res.ok) {
                    const msg = await res.text();
                    mostrarMensaje(msg, 'danger');
                    return;
                }
                resetForm();
                listarDocumentos();
                mostrarMensaje('Documento creado/modificado con éxito', 'success');
            } catch (err) {
                console.error(err);
                mostrarMensaje('Error al guardar el documento', 'danger');
            }
        });

        async function editarDocumento(idTipoDocumento, idPersona) {
            const res = await fetch(`${apiBase}/${idTipoDocumento}/${idPersona}`);
            const d = await res.json();
            document.getElementById('idPersona').value = idPersona;
            document.getElementById('idTipoDocumento').value = idTipoDocumento;
            document.getElementById('noDocumento').value = d.noDocumento;
            document.getElementById('idPersona').disabled = true;
            document.getElementById('idTipoDocumento').disabled = true;
            document.getElementById('form-title').innerText = 'Editar Documento';
        }

        async function eliminarDocumento(idTipoDocumento, idPersona) {
            if (confirm('¿Seguro que deseas eliminar este documento?')) {
                const res = await fetch(`${apiBase}/${idTipoDocumento}/${idPersona}`, { method: 'DELETE' });
                if (res.ok) {
                    listarDocumentos();
                    mostrarMensaje('Documento eliminado con éxito', 'success');
                } else {
                    const msg = await res.text();
                    mostrarMensaje(`Error: ${msg}`, 'danger');
                }
            }
        }

        document.getElementById('cancelar').addEventListener('click', resetForm);

        function resetForm() {
            document.getElementById('documento-form').reset();
            document.getElementById('form-title').innerText = 'Nuevo Documento';
            document.getElementById('idPersona').disabled = false;
            document.getElementById('idTipoDocumento').disabled = false;
        }

        cargarPersonas();
        cargarTipoDocumento();
        listarDocumentos();
    </script>
</body>
</html>
