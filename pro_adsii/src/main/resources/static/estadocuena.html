<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estado de Cuenta</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        /* Oculta los controles de búsqueda al imprimir */
        @media print {
            .no-print { display: none !important; }
            body { font-size: 10pt; }
        }
        .header-reporte { 
            border: 2px solid #343a40; 
            padding: 15px; 
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4 no-print">Consulta de Estado de Cuenta</h2>
        
        <div class="row mb-3 g-2 no-print">
            <div class="col-md-2"><input type="number" id="idCliente" class="form-control" placeholder="ID Cliente"></div>
            <div class="col-md-2"><input type="number" id="idCuenta" class="form-control" placeholder="ID Cuenta"></div>
            <div class="col-md-2"><input type="text" id="nombre" class="form-control" placeholder="Nombre"></div>
            <div class="col-md-2"><input type="text" id="apellido" class="form-control" placeholder="Apellido"></div>
            
            <div class="col-md-4">
                <div class="input-group">
                    <input type="date" id="fechaInicio" class="form-control" title="Fecha Inicio" required>
                    <input type="date" id="fechaFin" class="form-control" title="Fecha Fin" required>
                </div>
            </div>
            
            <div class="col-md-2"><button class="btn btn-primary w-100" onclick="buscar()">Buscar</button></div>
            <div class="col-md-2"><button class="btn btn-secondary w-100" onclick="window.print()">Imprimir</button></div>
        </div>

        <div class="header-reporte">
            <h4 class="text-center">REPORTE ESTADO DE CUENTA</h4>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <strong>Cliente:</strong> <span id="clienteNombre">N/A</span> (<span id="clienteID">N/A</span>)<br>
                    <strong>Tipo de Cuenta:</strong> <span id="tipoCuenta">N/A</span>
                </div>
                <div class="col-md-6 text-end">
                    <strong>Número de Cuenta:</strong> <span id="cuentaId">N/A</span><br>
                    <strong>Período:</strong> <span id="periodo">N/A</span>
                </div>
            </div>
        </div>

        <table class="table table-bordered table-sm table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Fecha</th>
                    <th>Tipo de Movimiento</th>
                    <th>Descripción / Doc. Ref.</th>
                    <th class="text-end">Cargo (Q)</th>
                    <th class="text-end">Abono (Q)</th>
                    <th class="text-end">Saldo Acumulado (Q)</th>
                </tr>
            </thead>
            <tbody id="tabla-movimientos"></tbody>
        </table>

        <div class="row justify-content-end mt-4">
            <div class="col-md-4">
                <div class="border p-3">
                    <h5 class="mb-3">Resumen del Período</h5>
                    <strong>Total Cargos:</strong> Q <span id="totalCargos" class="float-end">0.00</span><br>
                    <strong>Total Abonos:</strong> Q <span id="totalAbonos" class="float-end">0.00</span><br>
                    <hr>
                    <strong class="text-primary">SALDO FINAL:</strong> <span id="saldoFinal" class="float-end text-primary">0.00</span>
                </div>
            </div>
        </div>
    </div>

<script>
    const apiBase = '/api/estado_cuenta';

    function formatDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleDateString('es-GT') + ' ' + date.toLocaleTimeString('es-GT');
    }

    async function buscar() {
        const idPersona = document.getElementById('idCliente').value || '';
        const idCuenta = document.getElementById('idCuenta').value || '';
        const nombre = document.getElementById('nombre').value || '';
        const apellido = document.getElementById('apellido').value || '';
        
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        if (!fechaInicio || !fechaFin) {
             alert('Por favor, ingrese el período (Fecha Inicio y Fecha Fin).');
             return;
        }

        // Formato para LocalDateTime en Spring (ej: 2023-01-01T00:00:00)
        const start = fechaInicio + 'T00:00:00';
        const end = fechaFin + 'T23:59:59';


        const url = `${apiBase}/buscar?idPersona=${idPersona}&idSaldoCuenta=${idCuenta}&nombre=${nombre}&apellido=${apellido}&fechaInicio=${start}&fechaFin=${end}`;
        
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
            const movimientos = await res.json();
            renderizar(movimientos, fechaInicio, fechaFin);
        } catch (error) {
            console.error('Error al buscar el estado de cuenta:', error);
            alert('Error al cargar los datos. Verifique los filtros y el estado del servicio.');
            document.getElementById('tabla-movimientos').innerHTML = '';
            // Limpiar encabezado
            document.getElementById('clienteNombre').textContent = 'N/A';
            document.getElementById('saldoFinal').textContent = '0.00';
        }
    }

    function renderizar(movimientos, fechaInicioStr, fechaFinStr) {
        const tbody = document.getElementById('tabla-movimientos');
        tbody.innerHTML = '';

        let totalCargos = 0;
        let totalAbonos = 0;

        if (movimientos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron movimientos para los filtros seleccionados.</td></tr>';
        }

        movimientos.forEach((m) => {
            totalCargos += m.cargo;
            totalAbonos += m.abono;

            tbody.innerHTML += `
                <tr>
                    <td>${formatDate(m.fechaMovimiento)}</td>
                    <td>${m.tipoMovimiento}</td>
                    <td>${m.descripcion}</td>
                    <td class="text-end">${m.cargo.toFixed(2)}</td>
                    <td class="text-end">${m.abono.toFixed(2)}</td>
                    <td class="text-end">${m.saldoAcumulado.toFixed(2)}</td>
                </tr>
            `;

            // Establecer el encabezado con datos del primer movimiento
            if (m === movimientos[0]) {
                document.getElementById('clienteNombre').textContent = `${m.nombre} ${m.apellido}`;
                document.getElementById('clienteID').textContent = m.idPersona;
                document.getElementById('cuentaId').textContent = m.idSaldoCuenta;
                document.getElementById('tipoCuenta').textContent = m.tipoSaldo;
            }
        });
        
        // Totales y Saldos
        document.getElementById('totalCargos').textContent = totalCargos.toFixed(2);
        document.getElementById('totalAbonos').textContent = totalAbonos.toFixed(2);
        
        // Saldo Final = (Total Cargos - Total Abonos) para CXC, o (Total Abonos - Total Cargos) para Cuenta de Ahorro.
        // Usamos la lógica del Service: Saldo Final = Saldo Acumulado del último movimiento
        const saldoFinal = movimientos.length > 0 ? movimientos[movimientos.length - 1].saldoAcumulado : 0.00;
        document.getElementById('saldoFinal').textContent = saldoFinal.toFixed(2);

        // Periodo
        document.getElementById('periodo').textContent = `Del ${fechaInicioStr} al ${fechaFinStr}`;
    }
</script>
</body>
</html>