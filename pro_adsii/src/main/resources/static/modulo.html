<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Módulos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center">Gestión de Módulos</h2>

    <!-- Formulario para agregar / editar -->
    <div class="card mb-4">
        <div class="card-header">Agregar / Editar Módulo</div>
        <div class="card-body">
            <input type="hidden" id="moduloId">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" id="nombreModulo" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col-md-2">
                    <input type="number" id="ordenMenu" class="form-control" placeholder="Orden" required>
                </div>
                <div class="col-md-3">
                    <input type="text" id="usuarioCreacion" class="form-control" placeholder="Usuario Creación" required>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button class="btn btn-primary" onclick="guardarModulo()" id="btnGuardar">Guardar</button>
                    <button class="btn btn-secondary" onclick="cancelarEdicion()" id="btnCancelar" style="display:none;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de módulos -->
    <div class="card">
        <div class="card-header">Listado de Módulos</div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Orden</th>
                    <th>Fecha Creación</th>
                    <th>Usuario Creación</th>
                    <th>Fecha Modificación</th>
                    <th>Usuario Modificación</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="modulo-body">
                    <tr><td colspan="8" class="text-center">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    async function cargarModulos() {
        const res = await fetch("/modulo/listar");
        const data = await res.json();

        const tbody = document.getElementById("modulo-body");
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">No hay módulos registrados.</td></tr>`;
            return;
        }

        data.forEach(m => {
            const row = `
                <tr>
                    <td>${m.idModulo}</td>
                    <td>${m.nombre ?? ""}</td>
                    <td>${m.ordenMenu ?? ""}</td>
                    <td>${m.fechaCreacion ? new Date(m.fechaCreacion).toLocaleString() : ""}</td>
                    <td>${m.usuarioCreacion ?? ""}</td>
                    <td>${m.fechaModificacion ? new Date(m.fechaModificacion).toLocaleString() : ""}</td>
                    <td>${m.usuarioModificacion ?? ""}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarModulo(${m.idModulo})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarModulo(${m.idModulo})">Eliminar</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function guardarModulo() {
        const id = document.getElementById("moduloId").value;
        const nombre = document.getElementById("nombreModulo").value;
        const ordenMenu = parseInt(document.getElementById("ordenMenu").value);
        const usuarioCreacion = document.getElementById("usuarioCreacion").value;

        if (!nombre || !ordenMenu || !usuarioCreacion) {
            return alert("Complete todos los campos requeridos");
        }

        const modulo = {
            idModulo: id || undefined,
            nombre,
            ordenMenu,
            usuarioCreacion
        };

        const metodo = id ? "POST" : "POST";
        await fetch("/modulo/guardar", {
            method: metodo,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(modulo)
        });

        cancelarEdicion();
        cargarModulos();
    }

    async function editarModulo(id) {
        const res = await fetch(`/modulo/${id}`);
        const m = await res.json();

        document.getElementById("moduloId").value = m.idModulo;
        document.getElementById("nombreModulo").value = m.nombre;
        document.getElementById("ordenMenu").value = m.ordenMenu;
        document.getElementById("usuarioCreacion").value = m.usuarioCreacion;

        document.getElementById("btnCancelar").style.display = "inline-block";
        document.getElementById("btnGuardar").textContent = "Actualizar";
    }

    function cancelarEdicion() {
        document.getElementById("moduloId").value = "";
        document.getElementById("nombreModulo").value = "";
        document.getElementById("ordenMenu").value = "";
        document.getElementById("usuarioCreacion").value = "";
        document.getElementById("btnCancelar").style.display = "none";
        document.getElementById("btnGuardar").textContent = "Guardar";
    }

    async function eliminarModulo(id) {
        if (!confirm("¿Seguro de eliminar este módulo?")) return;

        await fetch(`/modulo/eliminar/${id}`, { method: "DELETE" });
        cargarModulos();
    }

    cargarModulos();
</script>
</body>
</html>
