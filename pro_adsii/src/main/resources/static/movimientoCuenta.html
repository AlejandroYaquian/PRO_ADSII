<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Movimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Inicio</a>
    <span class="navbar-text text-white" id="navUsuario"></span>
  </div>
</nav>

<div class="container py-5">
  <h2 class="mb-4 text-center">Registrar Movimiento en Cuenta Corriente</h2>

  <!-- Búsqueda de cuenta -->
  <div class="card mb-4">
    <div class="card-header">Buscar Cuenta</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="number" id="idSaldoCuenta" class="form-control" placeholder="Ingrese ID de la Cuenta" min="0" />
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="buscarCuenta()">Buscar</button>
        </div>
      </div>
      <div class="mt-3" id="infoCuenta"></div>
    </div>
  </div>

  <!-- Formulario de movimiento -->
  <div class="card" id="formularioCard" style="display: none;">
    <div class="card-header">Registrar Movimiento</div>
    <div class="card-body">
      <form onsubmit="registrarMovimiento(event)">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="idTipoMovimiento" class="form-label">Tipo de Movimiento</label>
            <select class="form-select" id="idTipoMovimiento" required></select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="valorMovimiento" class="form-label">Valor del Movimiento</label>
            <input type="number" step="0.01" min="0" class="form-control" id="valorMovimiento" required />
          </div>
          <div class="col-md-6">
            <label for="descripcion" class="form-label">Descripción</label>
            <input type="text" class="form-control" id="descripcion" />
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-success">Registrar Movimiento</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const usuario = sessionStorage.getItem('usuarioActual') || 'admin';
  document.getElementById('navUsuario').textContent = usuario;

 async function buscarCuenta() {
  const id = document.getElementById("idSaldoCuenta").value;
  const infoDiv = document.getElementById("infoCuenta");
  const formCard = document.getElementById("formularioCard");

  try {
    // Cambiar la URL al nuevo endpoint personalizado
    const res = await fetch(`http://localhost:8080/saldo_cuenta/buscar-cuenta/${id}`);

    if (!res.ok) {
      // Si la cuenta no existe, mostramos el error personalizado
      const error = await res.json(); // Esperamos que el backend nos mande { error: "Cuenta no encontrada" }
      infoDiv.innerHTML = `<div class="alert alert-danger">${error.error || "Cuenta no encontrada"}</div>`;
      formCard.style.display = 'none';
      return;
    }

    const cuenta = await res.json();
    const nombreStatusCuenta = cuenta.statusCuenta.nombre;

    if (nombreStatusCuenta === 'Cuenta Cancelada') {
      infoDiv.innerHTML = `<div class="alert alert-danger">La cuenta está cancelada.</div>`;
      formCard.style.display = 'none';
      return;
    } else if (nombreStatusCuenta === 'Cuenta en Cobro Juridico') {
      infoDiv.innerHTML = `<div class="alert alert-danger">La cuenta está en cobro jurídico.</div>`;
      formCard.style.display = 'none';
      return;
    } else if (nombreStatusCuenta === 'Cuenta Bloqueda') {
      infoDiv.innerHTML = `<div class="alert alert-danger">La cuenta está bloqueada.</div>`;
      formCard.style.display = 'none';
      return;
    }

    const saldoActual = cuenta.saldoAnterior + cuenta.creditos - cuenta.debitos;

    infoDiv.innerHTML = `
      <div class="alert alert-success">
        Cuenta activa: <strong>${cuenta.idSaldoCuenta}</strong><br/>
        Titular: ${cuenta.persona.nombre} ${cuenta.persona.apellido}<br/>
        Saldo actual: $${saldoActual.toFixed(2)}
      </div>
    `;

    await cargarTiposMovimiento();
    formCard.style.display = 'block';

  } catch (err) {
    infoDiv.innerHTML = `<div class="alert alert-danger">Error inesperado: ${err.message}</div>`;
    formCard.style.display = 'none';
  }
}



  async function cargarTiposMovimiento() {
    const select = document.getElementById("idTipoMovimiento");
    const res = await fetch("http://localhost:8080/tipoMovimiento/getTipoMovimientos");
    if (!res.ok) return alert("Error cargando tipos de movimiento");

    const tipos = await res.json();
    select.innerHTML = tipos
      .map(t => `<option value="${t.idTipoMovimientoCXC}">${t.nombre}</option>`)
      .join('');
  }

  async function registrarMovimiento(event) {
  event.preventDefault();

  const movimiento = {
    saldoCuenta: {
      idSaldoCuenta: parseInt(document.getElementById("idSaldoCuenta").value)
    },
    tipoMovimientoCXC: {
      idTipoMovimientoCXC: parseInt(document.getElementById("idTipoMovimiento").value)
    },
    fechaMovimiento: new Date().toISOString(),
    valorMovimiento: parseFloat(document.getElementById("valorMovimiento").value),
    valorMovimientoPagado: null,
    generadoAutomaticamente: null,
    descripcion: document.getElementById("descripcion").value,
    fechaCreacion: null,
    usuarioCreacion: usuario,
    fechaModificacion: null,
    usuarioModificacion: null
  };

  try {
    const res = await fetch("http://localhost:8080/movimientoCuenta/agregar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(movimiento)
    });

    if (!res.ok) {
      // Leer el mensaje de error del cuerpo de la respuesta
      const errorData = await res.json();
      throw new Error(errorData.error || "No se pudo registrar el movimiento");
    }

    alert("Movimiento registrado correctamente");
    document.querySelector("form").reset();

  } catch (err) {
    alert("Error al registrar el movimiento: " + err.message);
  }
}

</script>

</body>
</html>
