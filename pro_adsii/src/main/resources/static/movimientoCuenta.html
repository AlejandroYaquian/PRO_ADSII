<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Movimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Inicio</a>
    <span class="navbar-text text-white" id="navUsuario"></span>
  </div>
</nav>

<div class="container py-5">
  <h2 class="mb-4 text-center">Registrar Movimiento en Cuenta Corriente</h2>

  <!-- Búsqueda de cuenta -->
  <div class="card mb-4">
    <div class="card-header">Buscar Cuenta</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="number" id="idSaldoCuenta" class="form-control" placeholder="Ingrese ID de la Cuenta">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="buscarCuenta()">Buscar</button>
        </div>
      </div>
      <div class="mt-3" id="infoCuenta"></div>
    </div>
  </div>

  <!-- Formulario de movimiento -->
  <div class="card" id="formularioCard" style="display: none;">
    <div class="card-header">Registrar Movimiento</div>
    <div class="card-body">
      <form onsubmit="registrarMovimiento(event)">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="fechaMovimiento" class="form-label">Fecha del Movimiento</label>
            <input type="date" class="form-control" id="fechaMovimiento" required>
          </div>
          <div class="col-md-6">
            <label for="idTipoMovimiento" class="form-label">Tipo de Movimiento</label>
            <select class="form-select" id="idTipoMovimiento" required></select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="valorMovimiento" class="form-label">Valor del Movimiento</label>
            <input type="number" step="0.01" class="form-control" id="valorMovimiento" required>
          </div>
          <div class="col-md-6">
            <label for="descripcion" class="form-label">Descripción</label>
            <input type="text" class="form-control" id="descripcion">
          </div>
        </div>

        <input type="hidden" id="usuarioCreacion" value="admin" />

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-success">Registrar Movimiento</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const usuario = sessionStorage.getItem('usuarioActual') || 'admin';
  document.getElementById('navUsuario').textContent = usuario;

  async function buscarCuenta() {
    const id = document.getElementById("idSaldoCuenta").value;
    const infoDiv = document.getElementById("infoCuenta");
    const formCard = document.getElementById("formularioCard");

    try {
      const res = await fetch(`http://localhost:8080/api/cuentas/${id}`);
      if (!res.ok) throw new Error("Cuenta no encontrada");

      const cuenta = await res.json();
      if (cuenta.statusCuenta !== 'ACTIVA') {
        infoDiv.innerHTML = `<div class="alert alert-danger">La cuenta no está activa.</div>`;
        formCard.style.display = 'none';
        return;
      }

      infoDiv.innerHTML = `
        <div class="alert alert-success">
          Cuenta activa: <strong>${cuenta.idSaldoCuenta}</strong><br/>
          Titular: ${cuenta.persona}<br/>
          Saldo actual: $${cuenta.saldoActual.toFixed(2)}
        </div>
      `;

      await cargarTiposMovimiento();
      formCard.style.display = 'block';
    } catch (err) {
      infoDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
      formCard.style.display = 'none';
    }
  }

  async function cargarTiposMovimiento() {
    const select = document.getElementById("idTipoMovimiento");
    const res = await fetch("http://localhost:8080/api/tipos-movimiento");
    if (!res.ok) return alert("Error cargando tipos de movimiento");

    const tipos = await res.json();
    select.innerHTML = tipos.map(t => `<option value="${t.idTipoMovimientoCXC}">${t.nombre}</option>`).join('');
  }

  async function registrarMovimiento(event) {
    event.preventDefault();

    const movimiento = {
      idSaldoCuenta: parseInt(document.getElementById("idSaldoCuenta").value),
      idTipoMovimientoCXC: parseInt(document.getElementById("idTipoMovimiento").value),
      fechaMovimiento: document.getElementById("fechaMovimiento").value,
      valorMovimiento: parseFloat(document.getElementById("valorMovimiento").value),
      descripcion: document.getElementById("descripcion").value,
      usuarioCreacion: usuario
    };

    try {
      const res = await fetch("http://localhost:8080/api/movimientos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(movimiento)
      });

      if (!res.ok) throw new Error("No se pudo registrar el movimiento");

      alert("Movimiento registrado correctamente");
      document.querySelector("form").reset();
    } catch (err) {
      alert("Error al registrar el movimiento: " + err.message);
    }
  }
</script>

</body>
</html>
