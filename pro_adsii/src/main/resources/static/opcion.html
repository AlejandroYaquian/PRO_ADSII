<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Opcion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"> 
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center">Gestión de Opcion</h2>

    <!-- Formulario para agregar / editar -->
    <div class="card mb-4">
        <div class="card-header">Agregar Opcion</div>
        <div class="card-body">
          <div class="container mt-3">
            <!-- Fila 1: Nombre + Orden Opción -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="nombreOpcion" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col-md-6">
                    <input type="text" id="ordenOpcion" class="form-control" placeholder="Orden Menu" required>
                </div>
            </div>

            <!-- Fila 2: Página + ComboBox de Menú -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="pagina" class="form-control" placeholder="Página" required>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <label for="menuId" class="me-2 mb-0">Menú</label>
                        <select id="menuId" class="form-select" required>
                            <!-- Opciones dinámicas -->
                        </select>
                    </div>
                    </div>
            </div>

            <!-- Fila 3: Botones -->
            <div class="row mb-3">
                <div class="col-md-12 d-flex gap-2">
                    <button class="btn btn-primary" onclick="guardarOpcion()">Guardar</button>
                    <button class="btn btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
                </div>
            </div>
        </div>         
        </div>
    </div>


<!-- Tabla de módulos -->
    <div class="card">
        <div class="card-header">Listado de Opciones</div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Menu</th>
                    <th>Nombre</th>
                    <th>Orden</th>
                    <th>Pagina</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="opcion-body">
                    <tr><td colspan="10" class="text-center">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
   
    let menus = [];
    let opcionEditandoId = null;


    async function cargarMenus() {
        
         try {
            const response = await fetch('http://localhost:8080/menu/listar');
            if (!response.ok) {
                throw new Error('Error al obtener los menús');
            }
            menus = await response.json(); // esto debe ser un array
            const select = document.getElementById('menuId');
            menus.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu.idMenu;           // Asegúrate de que tu objeto tenga 'id'
                option.textContent = menu.nombre; // Asegúrate de que tenga 'nombre'
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar los menús:', error);
        }     
            
    }

 

    async function cargarOpcion() {
        const res = await fetch("/opcion/listar");
        const data = await res.json();

        const tbody = document.getElementById("opcion-body");
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">No hay opciones registradas.</td></tr>`;
            return;
        }

        data.forEach(m => {
            const nombreMenu = menus.find(menu => menu.idMenu === m.idMenu)?.nombre || "Desconocido";
            const row = `
                <tr>
                    <td>${nombreMenu}</td>
                    <td>${m.nombre ?? ""}</td>
                    <td>${m.ordenMenu ?? ""}</td>
                    <td>${m.pagina ?? ""}</td>
                    <td>
                      <div class="d-flex gap-2">
                         <button class="btn btn-warning btn-sm" onclick="editarOpcion(${m.idOpcion})">Editar</button>
                         <button class="btn btn-danger btn-sm" onclick="eliminarOpcion(${m.idOpcion})">Eliminar</button>
                       </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function guardarOpcion() {
            const nombre = document.getElementById("nombreOpcion").value.trim();
            const ordenOpcion = document.getElementById("ordenOpcion").value.trim();
            const pagina = document.getElementById("pagina").value.trim();
            const menuId = document.getElementById("menuId").value;

            if (!nombre || !ordenOpcion || !pagina || !menuId) {
                return alert("Complete todos los campos requeridos.");
            }

            // Crear objeto para enviar
            const opcion = {
                idMenu: parseInt(menuId),
                nombre,
                ordenMenu: parseInt(ordenOpcion),
                pagina
            };

            // Si estamos editando, agregamos el idOpcion
            if (opcionEditandoId) {
                opcion.idOpcion = opcionEditandoId;
            }

            try {
                const response = await fetch("/opcion/guardar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(opcion)
                });

                if (!response.ok) {
                    throw new Error("Error al guardar la opción.");
                }

                const data = await response.json();
                alert(`Opción ${opcionEditandoId ? "actualizada" : "guardada"} con éxito: ${data.nombre}`);

                // Limpiar formulario
                cancelarEdicion();

                // Recargar tabla
                cargarOpcion();

            } catch (error) {
                console.error("Error al guardar la opción:", error);
                alert("Ocurrió un error al guardar. Revisa la consola.");
            }
    }



    async function editarOpcion(id) {
        try {
            const res = await fetch(`/opcion/${id}`); // Debes tener este endpoint en el backend
            if (!res.ok) throw new Error("No se pudo obtener la opción");

            const opcion = await res.json();

            // Guardar el ID que estamos editando
            opcionEditandoId = opcion.idOpcion;

            // Rellenar los campos
            document.getElementById("nombreOpcion").value = opcion.nombre || "";
            document.getElementById("ordenOpcion").value = opcion.ordenMenu || "";
            document.getElementById("pagina").value = opcion.pagina || "";
            document.getElementById("menuId").value = opcion.idMenu || "";

            // Cambiar texto del botón si quieres
            document.querySelector("button.btn-primary").textContent = "Actualizar";

        } catch (error) {
            console.error("Error al cargar la opción para edición:", error);
            alert("No se pudo cargar la opción.");
        }
    }


    function cancelarEdicion() {
        opcionEditandoId = null;

        document.getElementById("nombreOpcion").value = "";
        document.getElementById("ordenOpcion").value = "";
        document.getElementById("pagina").value = "";
        document.getElementById("menuId").value = "";

        // Restaurar texto del botón
        document.querySelector("button.btn-primary").textContent = "Guardar";
    }


    async function eliminarOpcion(id) {
        if (!confirm("¿Seguro de eliminar esta opción?")) return;

        try {
            const response = await fetch(`/opcion/eliminar/${id}`, { method: "DELETE" });

            if (!response.ok) {
                throw new Error("Error al eliminar");
            }

            alert("Opción eliminada correctamente.");
            cargarOpcion(); // Refresca la lista
        } catch (error) {
            console.error("Error al eliminar:", error);
            alert("No se pudo eliminar la opción.");
        }
    }


   document.addEventListener('DOMContentLoaded', async () => {
    await cargarMenus();     // Espera a que los menús estén listos
    await cargarOpcion();    // Luego carga las opciones
    });

</script>
</body>
</html>