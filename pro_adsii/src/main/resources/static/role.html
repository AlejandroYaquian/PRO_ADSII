<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Roles</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary w-100 mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Gestión de Roles y Permisos</a>
    </div>
  </nav>

  <div class="container">
    <h2 class="mb-4">Selecciona un rol</h2>
    
    <form id="form-opciones">
      <!-- Aquí se insertan los radios dinámicamente -->
      <div class="mt-3 d-flex gap-2" id="botones-container">
        <button type="submit" class="btn btn-primary" id="btn-modificar">Modificar Rol</button>
        <button type="submit" class="btn btn-primary" id="btn-agregar">Agregar Rol</button>
      </div>
    </form>

    <!-- Label para mostrar el rol seleccionado -->
    <div class="mt-4" id="rol-seleccionado" style="display: none;">
      <label class="form-label fw-bold">Rol seleccionado: <span id="nombre-rol"></span></label>
    </div>

    <!-- Formulario para agregar nuevo rol -->
    <div class="mt-4" id="form-agregar-rol" style="display: none;">
      <h4>Agregar nuevo rol</h4>
      <form id="form-nuevo-rol">
        <div class="mb-3">
          <label for="nombreNuevoRol" class="form-label">Nombre del nuevo rol</label>
          <input type="text" class="form-control" id="nombreNuevoRol" required>
        </div>
        <button type="submit" class="btn btn-success">Guardar Rol</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Cargar roles dinámicamente desde el backend
      fetch('http://localhost:8080/role/getRoles')
        .then(response => response.json())
        .then(roles => {
          const form = document.getElementById('form-opciones');

          roles.forEach(rol => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2 role-radio';

            const input = document.createElement('input');
            input.className = 'form-check-input';
            input.type = 'radio';
            input.name = 'opcionSeleccionada';
            input.id = 'rol' + rol.idRole;
            input.value = rol.idRole;
            input.setAttribute('data-nombre', rol.nombre);

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = input.id;
            label.textContent = rol.nombre;

            div.appendChild(input);
            div.appendChild(label);

            form.insertBefore(div, document.getElementById('botones-container'));
          });
        })
        .catch(error => {
          console.error('Error al cargar los roles:', error);
        });

      // MANEJAR ENVÍO DEL FORMULARIO PRINCIPAL (PARA MODIFICAR)
      document.getElementById('form-opciones').addEventListener('submit', function (e) {
        e.preventDefault();

        const selected = document.querySelector('input[name="opcionSeleccionada"]:checked');
        if (!selected) {
          alert('Por favor, selecciona un rol antes de continuar.');
          return;
        }

        document.querySelectorAll('.role-radio').forEach(el => el.style.display = 'none');
        document.getElementById('btn-modificar').style.display = 'none';
        document.getElementById('btn-agregar').style.display = 'none';

        const nombreRol = selected.getAttribute('data-nombre');
        document.getElementById('nombre-rol').textContent = nombreRol;
        document.getElementById('rol-seleccionado').style.display = 'block';
      });

      // MANEJAR CLIC EN BOTÓN AGREGAR ROL
      document.getElementById('btn-agregar').addEventListener('click', function (e) {
        e.preventDefault();

        document.querySelectorAll('.role-radio').forEach(el => el.style.display = 'none');
        document.getElementById('btn-agregar').style.display = 'none';
        document.getElementById('btn-modificar').style.display = 'none';
        document.getElementById('rol-seleccionado').style.display = 'none';

        document.getElementById('form-agregar-rol').style.display = 'block';
      });

      // ✅ MANEJAR ENVÍO DEL NUEVO ROL (ACTUALIZADO)
      document.getElementById('form-nuevo-rol').addEventListener('submit', function (e) {
        e.preventDefault();

        const nuevoRol = document.getElementById('nombreNuevoRol').value.trim();
        if (!nuevoRol) {
          alert('Por favor, ingresa un nombre para el nuevo rol.');
          return;
        }

        const data = {
          nombre: nuevoRol
        };

        fetch('http://localhost:8080/role/agregar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Error al guardar el rol');
            }
            return response.json();
          })
          .then(result => {
            alert(`Rol "${result.nombre}" guardado correctamente.`);

            // Limpiar y ocultar formulario
            document.getElementById('form-nuevo-rol').reset();
            document.getElementById('form-agregar-rol').style.display = 'none';

            // Recargar roles (opcional)
            location.reload(); // ← recarga la página para mostrar el nuevo rol
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al guardar el rol.');
          });
      });
    });
  </script>
</body>
</html>
