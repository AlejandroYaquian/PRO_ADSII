<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    #btnCerrarSesion {
        background-color: transparent;
        border: 1px solid #fff;
        color: #fff;
    }
    #btnCerrarSesion:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
</style>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Inicio</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
      <span class="navbar-text me-3 fw-semibold" id="navUsuario"></span>
    </div>
  </div>
</nav>




<!-- PANTALLA ROLE---------------------------------------------------------->

<!-- Formulario de agregar rol--->
<h2 class="mt-4 mb-4 text-center">Gestión de Rol</h2> 
<div class="card w-50 mx-auto mt-4">
  <div class="card-header">Agregar Rol</div>
      
  <div class="card-body text-center">
    <form id="form-nuevo-rol">
      <div class="mb-3">
        <label for="nombreNuevoRol" class="form-label">Nombre del nuevo rol</label>
        <input type="text" class="form-control form-control-sm mx-auto" style="width: 60%;" id="nombreNuevoRol" required>
      </div>
      <div class="d-flex justify-content-center gap-2 mt-3">
        <button type="submit" id="btn-guardar" class="btn btn-primary" style="display: block;">Guardar</button>
      </div>
    </form>
  </div>
  </div>
</div>

<!-- Listado de roles --->

<div class="card w-50 mx-auto mt-4 mb-4">
  <div class="card-header">Listado de Opciones</div>
    <div class="card-body">
    <!-- Aquí vamos a mostrar la tabla con los roles--------------------------------------------------------------->
      <form id="form-opciones" class="mt-4">
        <!-- Título arriba de la tabla -->
        <h5 class="mb-3" id="labelListRole">Listado de Roles</h5>

        <div class="table-responsive shadow-sm rounded w-100">
          <table id='rolesTable' class="table table-bordered table-hover table-striped align-middle w-100">
            <thead id="thead-roles" class="table-dark">
              <tr>
                <th scope="col">No.</th>
                <th scope="col">Nombre del Rol</th>
                <th scope="col" class="text-center">Acciones Rol</th>
                <th scope="col" class="text-center">Editar opciones de rol</th>
              </tr>
            </thead>
            <tbody id="roles-table-body">
              <!-- Los roles se insertarán dinámicamente aquí -->
            </tbody>
          </table>
        </div>     
      </form>
    </div>
  </div>
</div>


<!--ESTRUCTURA DEL DOM FIN**********************************************************************************************************************-->

  <script>
  const API_URL_ROLEOPCION = "http://localhost:8080/RoleOpcion";
  const idRole = sessionStorage.getItem("idRole");
  let permisosUsuario = [];

  const usuario = sessionStorage.getItem('usuarioActual');

  if (!usuario) {
    window.location.href = 'login.html';
  } else {
    document.getElementById('navUsuario').textContent = usuario;
  }

  const tableBody = document.getElementById('roles-table-body');


  async function cargarPermisos() {
    const res = await fetch(`${API_URL_ROLEOPCION}/opcionesRol/${idRole}`);
    permisosUsuario = await res.json();
    aplicarPermisosUI();
  }

  function aplicarPermisosUI() {
    document.getElementById("btn-guardar").disabled = !tienePermiso("Roles", "alta");
  }

  function tienePermiso(nombreOpcion, permiso) {
    const op = permisosUsuario.find(o => o.nombre.toLowerCase() === nombreOpcion.toLowerCase());
    return op ? op[permiso.toLowerCase()] === true : false;
  }

  function cargarRoles() {

    const puedeEditarRoles = !tienePermiso("Roles", "cambio");
    const puedeEliminarRoles = !tienePermiso("Roles", "baja");

    fetch('http://localhost:8080/role/getRoles')
      .then(response => response.json())
      .then(roles => {
        roles.forEach(rol => {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = rol.idRole;

          const tdName = document.createElement('td');
          const inputName = document.createElement('input');
          inputName.type = 'text';
          inputName.value = rol.nombre;
          inputName.disabled = true;
          inputName.className = 'form-control form-control-sm';

          const tdSelect = document.createElement('td');
          tdSelect.className = 'align-middle text-center';
          const selectBtn = document.createElement('button');
          selectBtn.className = 'btn btn btn-primary text-white btn-sm';
          selectBtn.textContent = 'Editar opciones de rol';
          selectBtn.setAttribute('type', 'button');
          selectBtn.setAttribute('data-id', rol.idRole);
          selectBtn.setAttribute('data-nombre', rol.nombre);
          selectBtn.disabled = puedeEditarRoles; 
          
          selectBtn.addEventListener('click', function () {
            const id = rol.idRole;
            const nombre = encodeURIComponent(rol.nombre);
            window.location.href = `roleOpcion.html?idRol=${id}&nombre=${nombre}`;
          });
          tdSelect.appendChild(selectBtn);

          const tdEdit = document.createElement('td');
          tdEdit.className = 'align-middle text-center';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm text-white';
          deleteBtn.textContent = 'Eliminar rol';
          deleteBtn.setAttribute('type', 'button');
          deleteBtn.setAttribute('data-id', rol.idRole);
          deleteBtn.setAttribute('data-nombre', rol.nombre);
          deleteBtn.disabled = puedeEliminarRoles; 
          deleteBtn.addEventListener('click', () => {
            const rolId = deleteBtn.getAttribute('data-id');
            const rolNombre = deleteBtn.getAttribute('data-nombre');

            if (confirm(`¿Estás seguro de eliminar el rol "${rolNombre}"? Esta acción no se puede deshacer.`)) {
              fetch(`http://localhost:8080/role/eliminar/${rolId}`, {
                method: 'DELETE',
              })
                .then(response => {
                  if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                  }
                  return response.text();
                })
                .then(message => {
                  alert(message);
                  location.reload();
                })
                .catch(error => {
                  alert('Error al eliminar el rol: ' + error.message);
                });
            }
          });

          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-warning btn-sm text-black me-2';
          editBtn.textContent = 'Editar Rol';
          editBtn.setAttribute('type', 'button');
          editBtn.setAttribute('data-id', rol.idRole);
          editBtn.setAttribute('data-nombre', rol.nombre);
          editBtn.disabled = puedeEditarRoles; 
          editBtn.addEventListener('click', function () {
            deleteBtn.style.display = 'none';
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => btn.disabled = true);
            inputName.disabled = false;
            inputName.focus();

            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success btn-sm ms-2';
            saveBtn.textContent = 'Guardar';
            saveBtn.type = 'button';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary btn-sm ms-2';
            cancelBtn.textContent = 'Cancelar';

            tdEdit.appendChild(saveBtn);
            tdEdit.appendChild(cancelBtn);
            editBtn.style.display = 'none';

            saveBtn.addEventListener('click', () => {
              deleteBtn.style.display = '';
              event.preventDefault();
              const usu = sessionStorage.getItem('usuarioActual');
              const data = {
                idRole: editBtn.getAttribute('data-id'),
                nombre: inputName.value,
                usuario: usu
              };
              fetch('http://localhost:8080/role/editar', {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Error al guardar el rol');
                  }
                  return response.text().then(text => {
                    try {
                      return JSON.parse(text);
                    } catch {
                      throw new Error("Respuesta no es JSON válido");
                    }
                  });
                })
                .then(result => {
                  alert(`Rol "${result.nombre}" guardado correctamente.`);
                  location.reload();
                })
                .catch(error => {
                  alert('Ocurrió un error al guardar el rol: ' + error.message);
                });
            });

            cancelBtn.addEventListener('click', () => {
              deleteBtn.style.display = '';
              inputName.value = rol.nombre;
              inputName.disabled = true;
              allButtons.forEach(btn => btn.disabled = false);
              saveBtn.remove();
              cancelBtn.remove();
              editBtn.style.display = '';
            });
          });

          tdEdit.appendChild(editBtn);
          tdEdit.appendChild(deleteBtn);

          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdEdit);
          tr.appendChild(tdSelect);
          tdName.appendChild(inputName);
          tableBody.appendChild(tr);
        });
      });
  }

  // ✅ Evento para guardar nuevo rol
  document.getElementById('form-nuevo-rol').addEventListener('submit', function (e) {
    e.preventDefault();
    const nuevoRol = document.getElementById('nombreNuevoRol').value.trim();
    if (!nuevoRol) {
      alert('Por favor, ingresa un nombre para el nuevo rol.');
      return;
    }

    const usu = sessionStorage.getItem('usuarioActual');
    const data = {
      nombre: nuevoRol,
      usuario: usu
    };
    fetch('http://localhost:8080/role/agregar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al guardar el rol');
        }
        return response.json();
      })
      .then(result => {
        alert(`Rol "${result.nombre}" guardado correctamente.`);
        document.getElementById('form-nuevo-rol').reset();
        location.reload();
      })
      .catch(error => {
        alert('Ocurrió un error al guardar el rol.');
      });
  });


  document.addEventListener('DOMContentLoaded', async () => {
    await cargarPermisos();
    cargarRoles();          
  });
</script>

</body>

</html>