<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Opciones disponibles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">


    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3" id="navUsuario"></span>
            </div>
        </div>
    </nav>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 0px;
    }

    ul {
      font-size: 16px;
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
    }

    @media print {
      #btn-imprimir {
        display: none;
      }
    }
  </style>



</head>

<body>
<div class="mt-3 mb-3">
  <label id="label-rol" class="fw-bold fs-5"></label>
  <button class="btn btn-primary" onclick="volverRole()">Volver a roles</button>
</div> 
 <div class="table-responsive shadow-sm rounded w-100">
      <table  class="table table-bordered table-hover table-striped align-middle w-100">
        <thead  class="table-dark" >
          <tr>
            <th scope="col">Nombre del Modulo</th>
            <th scope="col">Nombre del Menu</th>
            <th scope="col">Nombre de la opción</th>
            <th scope="col" class="text-center" style="width: 80px;">Alta</th>
            <th scope="col" class="text-center" style="width: 80px;">Baja</th>
            <th scope="col" class="text-center" style="width: 80px;">Cambio</th>
            <th scope="col" class="text-center" style="width: 100px;">Imprimir</th>
            <th scope="col" class="text-center" style="width: 100px;">Exportar</th>
            <th scope="col" class="text-center" style="width: 120px;">Modificar</th>
          </tr>
        </thead>
        <tbody id="options-table-body">
          <!-- Las filas se insertarán dinámicamente -->
        </tbody>
      </table>
</div>
 

<script>
  // Obtener idRol desde la URL
  const queryParams = new URLSearchParams(window.location.search);
  const idRol = queryParams.get("idRol");
  const nombre = queryParams.get("nombre");
  const tableOptions = document.getElementById('options-table-body');

  const label = document.getElementById('label-rol');

      const usuario = sessionStorage.getItem('usuarioActual');

    if (!usuario) {
      window.location.href = 'login.html';
    } else {
      document.getElementById('navUsuario').textContent = usuario;
    }



  label.textContent = `Opciones del rol: ${nombre}`;
  getOptions(idRol);

   function getOptions(idRol) {
        fetch(`http://localhost:8080/RoleOpcion/opcionesRol/${idRol}`)
          .then(response => response.json())
          .then(opciones => {
            opciones.forEach(opcion => {
              const tr = document.createElement('tr');

              //Modulo
              const tdModulo = document.createElement('td');
              tdModulo.textContent = opcion.modulo;
              tdModulo.style.width = '175px';

              //Menu
              const tdMenu = document.createElement('td');
              tdMenu.textContent = opcion.menu;
              tdMenu.style.width = '175px';

              // Nombre
              const tdName = document.createElement('td');
              tdName.textContent = opcion.nombre;
              tdName.style.width = '175px';

              // Alta
              const tdAlta = document.createElement('td');
              const chkAlta = document.createElement('input');
              chkAlta.type = 'checkbox';
              chkAlta.checked = opcion.alta;
              chkAlta.disabled = true;
              tdAlta.classList.add('text-center');
              tdAlta.style.width = '80px';
              tdAlta.appendChild(chkAlta);

              // Baja
              const tdBaja = document.createElement('td');
              const chkBaja = document.createElement('input');
              chkBaja.type = 'checkbox';
              chkBaja.checked = opcion.baja;
              chkBaja.disabled = true;
              tdBaja.classList.add('text-center');
              tdBaja.style.width = '80px';
              tdBaja.appendChild(chkBaja);

              //Cambio
              const tdCambio = document.createElement('td');
              const chkCambio = document.createElement('input');
              chkCambio.type = 'checkbox';
              chkCambio.checked = opcion.cambio;
              chkCambio.disabled = true;
              tdCambio.classList.add('text-center');
              tdCambio.style.width = '80px';
              tdCambio.appendChild(chkCambio);

              // Imprimir
              const tdImprimir = document.createElement('td');
              const chkImprimir = document.createElement('input');
              chkImprimir.type = 'checkbox';
              chkImprimir.checked = opcion.imprimir;
              chkImprimir.disabled = true;
              tdImprimir.classList.add('text-center');
              tdImprimir.style.width = '100px';
              tdImprimir.appendChild(chkImprimir);

              // Exportar
              const tdExportar = document.createElement('td');
              const chkExportar = document.createElement('input');
              chkExportar.type = 'checkbox';
              chkExportar.checked = opcion.exportar;
              chkExportar.disabled = true;
              tdExportar.classList.add('text-center');
              tdExportar.style.width = '98px';
              tdExportar.appendChild(chkExportar);

              // Botón Seleccionar
              const tdSelect = document.createElement('td');
              const selectBtn = document.createElement('button');
              selectBtn.className = 'btn btn-warning btn-sm text-black me-2';
              selectBtn.textContent = 'Editar';
              selectBtn.setAttribute('data-id', opcion.idOpcion);
              selectBtn.setAttribute('data-nombre', opcion.nombre);
              selectBtn.setAttribute('data-role', idRol);
              tdSelect.classList.add('text-center');
              tdSelect.appendChild(selectBtn);

              // Agregar al row
              tr.appendChild(tdModulo);
              tr.appendChild(tdMenu);
              tr.appendChild(tdName);
              tr.appendChild(tdAlta);
              tr.appendChild(tdBaja);
              tr.appendChild(tdCambio);
              tr.appendChild(tdImprimir);
              tr.appendChild(tdExportar);
              tr.appendChild(tdSelect);

              tableOptions.appendChild(tr);

              // Evento para activar checkboxes y cambiar el botón a "Guardar"
              selectBtn.addEventListener('click', function seleccionarHandler() {
                // Activar checkboxes
                chkAlta.disabled = false;
                chkBaja.disabled = false;
                chkCambio.disabled = false;
                chkImprimir.disabled = false;
                chkExportar.disabled = false;

                // Deshabilitar todos los demás botones "Seleccionar"
                const allSelectButtons = document.querySelectorAll('button[data-id]');
                allSelectButtons.forEach(btn => {
                  btn.disabled = true;
                  btn.classList.remove('btn-info');
                  btn.classList.add('btn-secondary');
                });

                // Habilitar solo este botón y cambiar su texto
                selectBtn.disabled = false;
                selectBtn.textContent = 'Guardar';
                selectBtn.classList.remove('btn-secondary');
                selectBtn.classList.add('btn-primary');


                // Remover este handler para evitar múltiples bindings
                selectBtn.removeEventListener('click', seleccionarHandler);

                // Agregar nuevo handler para guardar
                selectBtn.addEventListener('click', function guardarHandler() {
                  // recolectar los datos
                const usu = sessionStorage.getItem('usuarioActual');  
                  const datos = {
                    idOpcion: selectBtn.getAttribute('data-id'),
                    idRole: selectBtn.getAttribute('data-role'),
                    nombre: selectBtn.getAttribute('data-nombre'),
                    alta: chkAlta.checked,
                    baja: chkBaja.checked,
                    cambio: chkCambio.checked,
                    imprimir: chkImprimir.checked,
                    exportar: chkExportar.checked,
                    usuario: usu
                  };

                  fetch('http://localhost:8080/RoleOpcion/editarRoleOpcion', {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                  })
                    .then(response => {
                      if (!response.ok) {
                        throw new Error('Error al editar opcion')
                      }
                      return response.json();
                    }).then(data => {
                      console.log('Opciones de Role Actualizada')
                    })
                    .catch(error => {
                      console.error('Error en la peticion')
                    })

                  console.log('Guardando datos:', datos);

                  // Desactivar checkboxes nuevamente
                  chkAlta.disabled = true;
                  chkBaja.disabled = true;
                  chkCambio.disabled = true;
                  chkImprimir.disabled = true;
                  chkExportar.disabled = true;

                  // Restaurar texto y estilo del botón
                  selectBtn.textContent = 'Editar';
                  selectBtn.classList.remove('btn-success');
                  selectBtn.classList.add('btn-info');

                  // Habilitar todos los botones "Seleccionar"
                  allSelectButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-info');
                  });

                  // Remover el handler de guardar y volver a agregar el de seleccionar
                  selectBtn.removeEventListener('click', guardarHandler);
                  selectBtn.addEventListener('click', seleccionarHandler);
                });
              });
            });
          })
          .catch(error => {
            console.error('Error al cargar opciones:', error);
          });
      }

      function volverRole() {
        window.location.href = 'role.html'
      }

    
</script>


</body>
</html>
