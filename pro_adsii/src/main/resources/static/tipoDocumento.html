<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>CRUD Tipo Documento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3 fw-semibold" id="navUsuario"></span>
            </div>
        </div>
    </nav>
    <div class="container mt-5">
        <h2 class="mb-4">Gestión de Tipos de Documento</h2>
        <h4 id="form-title" class="mb-3">Agregar Tipo Documento</h4>
        <form id="formCrear" class="row g-3 mb-5">
            <input type="hidden" id="idTipoDocumento">
            <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" id="nombre" name="nombre" class="form-control" required>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-success" id="btnSubmit">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnCancelar" style="display:none;">Cancelar</button>
            </div>
        </form>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Fecha Creación</th>
                    <th>Usuario Creación</th>
                    <th>Fecha Modificación</th>
                    <th>Usuario Modificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaTipoDocumento">
            </tbody>
        </table>
    </div>

    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <script>
        const apiUrl = "http://localhost:8080/api/tipodocumento";
        const usuario = sessionStorage.getItem('usuarioActual') || 'admin';

        if (!usuario) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('navUsuario').textContent = usuario;
        }

        function mostrarMensaje(mensaje, tipo = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        async function cargarDatos() {
            const res = await fetch(apiUrl);
            const data = await res.json();
            let filas = "";
            data.forEach(td => {
                filas += `
            <tr>
                <td>${td.idTipoDocumento}</td>
                <td>${td.nombre}</td>
                <td>${td.fechaCreacion ?? ''}</td>
                <td>${td.usuarioCreacion ?? ''}</td>
                <td>${td.fechaModificacion ?? ''}</td>
                <td>${td.usuarioModificacion ?? ''}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editar(${td.idTipoDocumento}, '${td.nombre}')">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminar(${td.idTipoDocumento})">Eliminar</button>
                </td>
            </tr>
        `;
            });
            document.getElementById("tablaTipoDocumento").innerHTML = filas;
        }

        document.getElementById("formCrear").addEventListener("submit", async e => {
            e.preventDefault();
            const id = document.getElementById("idTipoDocumento").value;
            const nombre = document.getElementById("nombre").value;

            try {
                if (id) {
                    const res = await fetch(`${apiUrl}/${id}?usuario=${usuario}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombre })
                    });
                    if (!res.ok) {
                        const msg = await res.text();
                        mostrarMensaje(msg, 'danger');
                        return;
                    }
                    mostrarMensaje('Tipo Documento actualizado con éxito', 'success');
                } else {
                    const res = await fetch(`${apiUrl}?usuario=${usuario}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombre })
                    });
                    if (!res.ok) {
                        const msg = await res.text();
                        mostrarMensaje(msg, 'danger');
                        return;
                    }
                    mostrarMensaje('Tipo Documento creado con éxito', 'success');
                }
                resetForm();
                cargarDatos();
            } catch (err) {
                console.error(err);
                mostrarMensaje('Error al guardar el registro', 'danger');
            }
        });

        function editar(id, nombre) {
            document.getElementById("idTipoDocumento").value = id;
            document.getElementById("nombre").value = nombre;
            document.getElementById("form-title").innerText = "Editar Tipo Documento";
            document.getElementById("btnSubmit").innerText = "Actualizar";
            document.getElementById("btnCancelar").style.display = "inline-block";
        }

        document.getElementById("btnCancelar").addEventListener("click", resetForm);

        function resetForm() {
            document.getElementById("formCrear").reset();
            document.getElementById("idTipoDocumento").value = "";
            document.getElementById("form-title").innerText = "Agregar Tipo Documento";
            document.getElementById("btnSubmit").innerText = "Guardar";
            document.getElementById("btnCancelar").style.display = "none";
        }


        async function eliminar(id) {
            if (confirm("¿Seguro que deseas eliminar este registro?")) {
                try {
                    const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
                    if (!res.ok) {
                        const msg = await res.text();
                        mostrarMensaje(msg, 'danger');
                        return;
                    }
                    mostrarMensaje('Registro eliminado con éxito', 'success');
                    cargarDatos();
                } catch (err) {
                    console.error(err);
                    mostrarMensaje('Error al eliminar el registro', 'danger');
                }
            }
        }

        cargarDatos();
    </script>
</body>

</html>