<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tipo de Movimiento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"> 
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Inicio</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
      <span class="navbar-text me-3 fw-semibold" id="navUsuario"></span>
    </div>
  </div>
</nav>

<!-- CONTENIDO -->
<div class="container py-5">
    <h2 class="mb-4 text-center">Gestión de tipo de movimiento cuenta corriente</h2>

    <!-- FORMULARIO -->
    <div class="card mb-4">
        <div class="card-header">Agregar / Editar Tipo de Movimiento</div>
        <div class="card-body">
          <div class="container mt-3">
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="nombreOpcion" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col-md-6">
                    <select id="operacionCuenta" class="form-select" required>
                        <option value="">Seleccione operación</option>
                        <option value="1">Cargo</option>
                        <option value="2">Abono</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12 d-flex gap-2">
                   <button id="btn-guardar" class="btn btn-primary" onclick="guardarOpcion()">Guardar</button>
                    <button class="btn btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
                </div>
            </div>
          </div>         
        </div>
    </div>

    <!-- TABLA -->
    <div class="card">
        <div class="card-header">Listado de Tipos de Movimiento</div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Operación Cuenta Corriente</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="opcion-body">
                    <tr><td colspan="10" class="text-center">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let opcionEditandoId = null;
    let permisosUsuario = [];
    const API_URL_ROLEOPCION = "http://localhost:8080/RoleOpcion";
    const idRole = sessionStorage.getItem("idRole");
    const usuario = sessionStorage.getItem('usuarioActual');

    if (!usuario) {
        window.location.href = 'login.html';
    } else {
        document.getElementById('navUsuario').textContent = usuario;
    }

    // --- CARGAR PERMISOS ---
    async function cargarPermisos() {
        const res = await fetch(`${API_URL_ROLEOPCION}/opcionesRol/${idRole}`);
        permisosUsuario = await res.json();
        aplicarPermisosUI();
    }

    function aplicarPermisosUI() {
        document.getElementById("btn-guardar").disabled = !tienePermiso("Tipos de Movimientos Cuenta Corriente", "alta");
    }

    function tienePermiso(nombreOpcion, permiso) {
        const op = permisosUsuario.find(o => o.nombre.toLowerCase() === nombreOpcion.toLowerCase());
        return op ? op[permiso.toLowerCase()] === true : false;
    }

    // --- CARGAR DATOS ---
    async function cargarOpcion() {
        const res = await fetch("/tipoMovimiento/getTipoMovimientos");
        const data = await res.json();

        const tbody = document.getElementById("opcion-body");
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center">No hay opciones registradas.</td></tr>`;
            return;
        }

        const puedeEditar = tienePermiso("Tipos de Movimientos Cuenta Corriente", "cambio");
        const puedeEliminar = tienePermiso("Tipos de Movimientos Cuenta Corriente", "baja");

        data.forEach(m => {
            const operacionTexto = m.operacionCuentaCorriente === 1 
                ? "Cargo" 
                : (m.operacionCuentaCorriente === 2 ? "Abono" : "Desconocido");

            const row = `
                <tr>
                    <td>${m.nombre ?? ""}</td>
                    <td>${operacionTexto}</td>
                    <td>
                      <div class="d-flex gap-2">
                         <button class="btn btn-warning btn-sm" onclick="editarOpcion(${m.idTipoMovimientoCXC})" ${!puedeEditar ? 'disabled' : ''}>Editar</button>
                         <button class="btn btn-danger btn-sm" onclick="eliminarOpcion(${m.idTipoMovimientoCXC})" ${!puedeEliminar ? 'disabled' : ''}>Eliminar</button>
                       </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- GUARDAR / ACTUALIZAR ---
    async function guardarOpcion() {
        const nombre = document.getElementById("nombreOpcion").value.trim();
        const operacionCuenta = document.getElementById("operacionCuenta").value;

        if (!nombre || !operacionCuenta) {
            return alert("Complete todos los campos requeridos.");
        }

        const operacionNumero = parseInt(operacionCuenta);
        const usu = sessionStorage.getItem('usuarioActual');
        const opcion = {
            nombre,
            operacionCuentaCorriente: operacionNumero,
        };

        if (opcionEditandoId) {
            opcion.idTipoMovimientoCXC = opcionEditandoId;
            opcion.usuarioModificacion = usu;
        } else {
            opcion.usuarioCreacion = usu;
        }

        try {
            const response = await fetch("/tipoMovimiento/agregar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(opcion)
            });

            if (!response.ok) throw new Error("Error al guardar el tipo de movimiento de cuenta.");

            const data = await response.json();
            alert(`Movimiento de cuenta ${opcionEditandoId ? "actualizado" : "guardado"} con éxito: ${data.nombre}`);

            cancelarEdicion();
            cargarOpcion();
        } catch (error) {
            console.error("Error al guardar la opción:", error);
            alert("Ocurrió un error al guardar. Revisa la consola.");
        }
    }

    // --- EDITAR ---
    async function editarOpcion(id) {
        try {
            const res = await fetch(`tipoMovimiento/buscarTipoMovimiento/${id}`);
            if (!res.ok) throw new Error("No se pudo obtener la opción");

            const opcion = await res.json();
            opcionEditandoId = opcion.idTipoMovimientoCXC;

            document.getElementById("nombreOpcion").value = opcion.nombre || "";
            document.getElementById("operacionCuenta").value = opcion.operacionCuentaCorriente?.toString() || "";

            document.querySelector("button.btn-primary").textContent = "Actualizar";
        } catch (error) {
            console.error("Error al cargar el movimiento de cuenta para edición:", error);
            alert("No se pudo cargar el movimiento de cuenta.");
        }
    }

    // --- CANCELAR EDICIÓN ---
    function cancelarEdicion() {
        opcionEditandoId = null;
        document.getElementById("nombreOpcion").value = "";
        document.getElementById("operacionCuenta").value = "";
        document.querySelector("button.btn-primary").textContent = "Guardar";
    }

    // --- ELIMINAR ---
    async function eliminarOpcion(id) {
        if (!confirm("¿Seguro de eliminar esta opción?")) return;

        try {
            const response = await fetch(`/tipoMovimiento/eliminar/${id}`, { method: "DELETE" });
            if (!response.ok) throw new Error("Error al eliminar");

            alert("Opción eliminada correctamente.");
            cargarOpcion();
        } catch (error) {
            console.error("Error al eliminar:", error);
            alert("No se pudo eliminar la opción.");
        }
    }

    // --- INICIO ---
    document.addEventListener('DOMContentLoaded', async () => {
        await cargarPermisos();
        await cargarOpcion();
    });
</script>
</body>
</html>
