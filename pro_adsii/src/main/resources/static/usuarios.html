<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Botón cerrar sesión (navbar) */
    #btnCerrarSesion { background-color: transparent; border: 1px solid #fff; color: #fff; }
    #btnCerrarSesion:hover { background-color: rgba(255, 255, 255, 0.2); }

    /* Estilos “Gestión de Usuarios” */
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --line:#e5e7eb;
      --primary:#0d6efd; --danger:#dc3545; --warning:#fd7e14; --header:#0b0b0b;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .wrapper{max-width:1180px;margin:24px auto;padding:0 16px}
    h1{margin:8px 0 20px;text-align:center;font-weight:700}
    .muted{color:var(--muted)}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px 16px;
          box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card + .card{margin-top:16px}
    .card-title{font-weight:600;color:#111;background:#f3f4f6;border:1px solid var(--line);
                border-radius:8px;padding:8px 10px;margin:-6px 0 12px}

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .row-2{grid-template-columns:repeat(2,1fr)}
    @media (max-width:960px){ .row,.row-2{grid-template-columns:1fr} }

    label{font-weight:600;font-size:12px;margin:4px 2px}
    input,select,button{padding:10px 12px;border:1px solid var(--line);border-radius:8px;font-size:14px}
    .right{display:flex;justify-content:flex-end;gap:8px}

    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:hidden;border-radius:10px}
    thead{background:var(--header);color:#fff}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#fafafa}
    .cell-actions{min-width:148px}

    .btn{cursor:pointer;border:none;border-radius:8px;padding:8px 12px;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.warn{background:var(--warning);color:#fff}
    .btn.light{background:#e5e7eb}
    .error{color:#b00020;font-weight:600}
    .ok{color:#0a7c2f;font-weight:600}
  </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Inicio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <span class="navbar-text me-3" id="navUsuario"></span>
            </div>
        </div>
    </nav>

  <div class="wrapper">
    <h1>Gestión de Usuarios</h1>
    <div class="muted"></div>

    <!-- Card: Formulario -->
    <div class="card">
      <div class="card-title">Agregar / Editar Usuario</div>
      <div id="msg"></div>

      <form id="formUsuario">
        <div class="row row-2">
          <div>
            <!-- ID editable al crear; se bloqueará al editar -->
            <label>ID de usuario (requerido al crear)</label>
            <input id="idUsuario" type="text" placeholder="ej. alejandro" />
          </div>
          <div>
            <label>Fotografía (URL/base64)</label>
            <input id="fotografia" type="text" placeholder="https://... o base64"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="nombre" required/>
          </div>
          <div>
            <label>Apellido</label>
            <input id="apellido" required/>
          </div>
          <div>
            <label>Fecha Nacimiento</label>
            <input id="fechaNacimiento" type="date" required />
          </div>
          <div>
            <label>Correo Electrónico</label>
            <input id="correoElectronico" type="email"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Teléfono Móvil</label>
            <input id="telefonoMovil" type="text"/>
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password"/>
          </div>
          <div>
            <label>Intentos de Acceso</label>
            <input id="intentosDeAcceso" type="number" value="0" min="0"/>
          </div>
          <div>
            <label>Requiere Cambiar Password</label>
            <select id="requiereCambiarPassword">
              <option value="false">No</option>
              <option value="true">Sí</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Pregunta</label>
            <input id="pregunta" type="text"/>
          </div>
          <div>
            <label>Respuesta</label>
            <input id="respuesta" type="text"/>
          </div>
          <div>
            <label>Género (IdGenero)</label>
            <select id="idGenero"></select>
          </div>
          <div>
            <label>Estatus (IdStatusUsuario)</label>
            <select id="idStatusUsuario"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Rol (IdRole)</label>
            <select id="idRole"></select>
          </div>
          <div>
            <label>Sucursal (IdSucursal)</label>
            <select id="idSucursal"></select>
          </div>
          <div>
            <label>Usuario Creación (solo info)</label>
            <input id="usuarioCreacion" readonly/>
          </div>
          <div>
            <label>Usuario Modificación (auto)</label>
            <input id="usuarioModificacion" placeholder="se envía en X-User" readonly/>
          </div>
        </div>

        <div class="right" style="margin-top:12px">
          <button type="button" class="btn light" onclick="limpiar()">Limpiar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>

    <!-- Card: Tabla -->
    <div class="card">
      <div class="card-title">Listado de Usuarios</div>
      <div class="right" style="margin:6px 2px 10px">
        <button class="btn light" onclick="cargarUsuarios()">Refrescar</button>
      </div>

      <div style="overflow:auto">
        <table id="tabla">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Email</th>
              <th>Estatus</th>
              <th>Rol</th>
              <th class="cell-actions">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="msgTabla" style="margin-top:10px;"></div>
    </div>
  </div> <!-- /.wrapper -->

  <script>
        const usuario = sessionStorage.getItem('usuarioActual');
        if (!usuario) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('navUsuario').textContent = usuario;
        }
  // ================== CONFIG ==================
  const API = '';                           // ← pon aquí tu base URL (p.ej. "http://localhost:8080")
  const H_USR = {'X-User':'admin'};         // ← header que usas

  // ================== HELPERS ==================
  const mapBy = (arr, key='id', label='nombre') =>
    Object.fromEntries((arr||[]).map(it => [String(it[key] ?? it['id']), it[label] ?? '']));

  let rolesById = {}, estatusById = {};

  async function safeFetch(url, opts) {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
    return res.json().catch(()=>null);
  }
  function toDateInput(value){ return value ? (''+value).substring(0,10) : ''; }
  function showMsg(id, txt, ok=true){
    const el = document.getElementById(id);
    if(!el) return;
    el.className = ok ? 'ok' : 'error';
    el.textContent = txt;
    clearTimeout(showMsg.timers?.[id]);
    showMsg.timers = showMsg.timers || {};
    showMsg.timers[id] = setTimeout(()=>{ el.textContent=''; el.className=''; }, 3500);
  }
  function getId(u){
    // ID técnico usado para acciones
    return u.idUsuario ?? u.id ?? u.uuid ?? u.codigo ?? '';
  }

  // ================== CATÁLOGOS ==================
  async function cargarCatalogo(url, selectId, valueField='id', labelField='nombre') {
    try{
      const data = await safeFetch(url, {headers:H_USR});
      const sel = document.getElementById(selectId);
      if (sel) {
        sel.innerHTML = '<option value="">-- Seleccione --</option>';
        (data||[]).forEach(it=>{
          const opt = document.createElement('option');
          opt.value = it[valueField] ?? it['id'];
          opt.textContent = it[labelField] ?? '';
          sel.appendChild(opt);
        });
      }
      return data || [];
    }catch(e){
      const sel = document.getElementById(selectId);
      if (sel) sel.innerHTML = '<option value="">(vacío)</option>';
      return [];
    }
  }

  // ================== LISTADO ==================
  async function cargarUsuarios(){
    try{
      const data = await safeFetch(`${API}/usuario/listar`, {headers:H_USR});
      const tb = document.querySelector('#tabla tbody');
      tb.innerHTML = '';

      (data||[]).forEach(u=>{
        const id = getId(u);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${id}</td>
          <td>${u.nombre ?? ''}</td>
          <td>${u.apellido ?? ''}</td>
          <td>${u.correoElectronico ?? ''}</td>
          <td>${nombreEstatus(u.idStatusUsuario)}</td>
          <td>${nombreRol(u.idRole)}</td>
          <td class="cell-actions">
            <div class="right">
              <button class="btn warn"   onclick='editar(${JSON.stringify(id)})'>Editar</button>
              <button class="btn danger" onclick='borrar(${JSON.stringify(id)})'>Eliminar</button>
            </div>
          </td>`;
        tb.appendChild(tr);
      });
    }catch(e){
      showMsg('msgTabla', `Error al listar: ${e.message}`, false);
    }
  }

  function nombreRol(id){ return rolesById[String(id ?? '')] ?? (id ?? ''); }
  function nombreEstatus(id){ return estatusById[String(id ?? '')] ?? (id ?? ''); }

  // ================== EDICIÓN ==================
  async function editar(id){
    try{
      const u = await safeFetch(`${API}/usuario/obtener/${encodeURIComponent(id)}`, {headers:H_USR});

      // Bloquea ID en edición
      const idEl = document.getElementById('idUsuario');
      idEl.value = getId(u) ?? '';
      idEl.readOnly = true;

      document.getElementById('nombre').value = u.nombre ?? '';
      document.getElementById('apellido').value = u.apellido ?? '';
      document.getElementById('fechaNacimiento').value = toDateInput(u.fechaNacimiento);
      document.getElementById('correoElectronico').value = u.correoElectronico ?? '';
      document.getElementById('telefonoMovil').value = u.telefonoMovil ?? '';

      // Nunca prellenar password con hash
      document.getElementById('password').value = '';

      document.getElementById('intentosDeAcceso').value = u.intentosDeAcceso ?? 0;
      document.getElementById('requiereCambiarPassword').value = String(u.requiereCambiarPassword ?? false);
      document.getElementById('pregunta').value = u.pregunta ?? '';
      document.getElementById('respuesta').value = u.respuesta ?? '';
      document.getElementById('idGenero').value = u.idGenero ?? '';
      document.getElementById('idStatusUsuario').value = u.idStatusUsuario ?? '';
      document.getElementById('idRole').value = u.idRole ?? '';
      document.getElementById('idSucursal').value = u.idSucursal ?? '';
      document.getElementById('fotografia').value = u.fotografia ?? '';
      document.getElementById('usuarioCreacion').value = u.usuarioCreacion ?? '';
      window.scrollTo({top:0, behavior:'smooth'});
    }catch(e){ showMsg('msg', `Error al obtener: ${e.message}`, false); }
  }

  // ================== BORRAR ==================
  async function borrar(id){
    if(!confirm(`¿Eliminar usuario ${id}?`)) return;
    try{
      await fetch(`${API}/usuario/eliminar/${encodeURIComponent(id)}`, {method:'DELETE', headers:H_USR});
      showMsg('msgTabla', 'Usuario eliminado');
      cargarUsuarios();
      limpiar();
    }catch(e){ showMsg('msgTabla', `Error al eliminar: ${e.message}`, false); }
  }

  // ================== GUARDAR ==================
  document.getElementById('formUsuario').addEventListener('submit', async (ev)=>{
    ev.preventDefault();

    const idEl = document.getElementById('idUsuario');
    const idRaw = idEl.value?.trim();
    const esAlta = !idEl.readOnly; // si está editable, es alta

    // Validaciones de alta
    if (esAlta && !idRaw) {
      showMsg('msg', 'El ID de usuario es obligatorio al crear', false);
      idEl.focus();
      return;
    }
    if (!document.getElementById('fechaNacimiento').value) {
      showMsg('msg', 'La fecha de nacimiento es obligatoria', false);
      return;
    }

    const body = {
      idUsuario: idRaw || null,
      nombre: document.getElementById('nombre').value || null,
      apellido: document.getElementById('apellido').value || null,
      fechaNacimiento: document.getElementById('fechaNacimiento').value || null,
      idStatusUsuario: document.getElementById('idStatusUsuario').value ? Number(document.getElementById('idStatusUsuario').value) : null,
      idGenero: document.getElementById('idGenero').value ? Number(document.getElementById('idGenero').value) : null,
      correoElectronico: document.getElementById('correoElectronico').value || null,
      telefonoMovil: document.getElementById('telefonoMovil').value || null,
      fotografia: document.getElementById('fotografia').value || null,
      idSucursal: document.getElementById('idSucursal').value ? Number(document.getElementById('idSucursal').value) : null,
      idRole: document.getElementById('idRole').value ? Number(document.getElementById('idRole').value) : null,
      intentosDeAcceso: document.getElementById('intentosDeAcceso').value ? Number(document.getElementById('intentosDeAcceso').value) : 0,
      requiereCambiarPassword: document.getElementById('requiereCambiarPassword').value === 'true',
      pregunta: document.getElementById('pregunta').value || null,
      respuesta: document.getElementById('respuesta').value || null
    };

    const pwd = document.getElementById('password').value.trim();
    if (pwd) body.password = pwd; // solo enviar si se escribió

    try{
      await safeFetch(`${API}/usuario/guardar`, {
        method:'POST',
        headers:{'Content-Type':'application/json', ...H_USR},
        body: JSON.stringify(body)
      });
      showMsg('msg', 'Guardado con éxito');
      cargarUsuarios();
      limpiar();
    }catch(e){
      showMsg('msg', `Error al guardar: ${e.message}`, false);
    }
  });

  function limpiar(){
    document.getElementById('formUsuario').reset();
    const idEl = document.getElementById('idUsuario');
    idEl.value = '';
    idEl.readOnly = false; // habilitar para nuevas altas
    document.getElementById('password').value = '';
  }

  // ================== INIT ==================
  (async function init(){
    const [est, gen, rol, suc] = await Promise.all([
      cargarCatalogo(`${API}/status_usuario/listar`, 'idStatusUsuario', 'idStatusUsuario', 'nombre'),
      cargarCatalogo(`${API}/genero/listar`,          'idGenero',        'idGenero',        'nombre'),
      cargarCatalogo(`${API}/role/getRoles`,          'idRole',          'idRole',          'nombre'),
      cargarCatalogo(`${API}/sucursal`,               'idSucursal',      'idSucursal',      'nombre'),
    ]);

    // Mapas para mostrar nombres en la tabla
    estatusById = mapBy(est, 'idStatusUsuario', 'nombre');
    rolesById   = mapBy(rol, 'idRole',          'nombre');

    cargarUsuarios();
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
